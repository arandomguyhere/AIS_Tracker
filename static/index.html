<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal Ship Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            height: 100vh;
            overflow: hidden;
        }

        /* Full screen map */
        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
        }

        /* Top bar */
        .top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: linear-gradient(180deg, rgba(26,26,46,0.95) 0%, rgba(26,26,46,0.85) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 600;
            font-size: 18px;
            white-space: nowrap;
        }

        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #e94560 0%, #c23a51 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 42px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input::placeholder { color: rgba(255,255,255,0.5); }
        .search-input:focus {
            background: rgba(255,255,255,0.15);
            border-color: #e94560;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.5);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0; right: 0;
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-results.active { display: block; }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-result-item:hover { background: rgba(255,255,255,0.05); }
        .search-result-item:last-child { border-bottom: none; }

        .result-icon {
            width: 32px; height: 32px;
            background: rgba(233,69,96,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-info { flex: 1; }
        .result-name { color: white; font-weight: 500; font-size: 14px; }
        .result-meta { color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 2px; }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-left: auto;
        }

        .stat {
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
        }

        .stat-critical .stat-value { color: #e94560; }
        .stat-warning .stat-value { color: #f39c12; }
        .stat-info .stat-value { color: #3498db; }

        /* Control buttons */
        .map-controls {
            position: absolute;
            top: 72px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .control-btn {
            width: 40px; height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
            font-size: 18px;
        }

        .control-btn:hover {
            background: #f8f9fa;
            transform: scale(1.05);
        }

        .control-btn.active {
            background: #e94560;
            color: white;
        }

        /* Vessel panel (slide-in from right) */
        .vessel-panel {
            position: absolute;
            top: 56px;
            right: 0;
            width: 380px;
            height: calc(100vh - 56px);
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .vessel-panel.active { transform: translateX(0); }

        .panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
            color: white;
            position: relative;
        }

        .panel-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px; height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-close:hover { background: rgba(255,255,255,0.2); }

        .vessel-icon-large {
            width: 48px; height: 48px;
            background: rgba(233,69,96,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .vessel-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .vessel-type {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .threat-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .threat-critical { background: #e94560; }
        .threat-high { background: #f39c12; }
        .threat-medium { background: #3498db; }
        .threat-low { background: #27ae60; }
        .threat-unknown { background: #95a5a6; }

        .panel-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .info-row:last-child { border-bottom: none; }
        .info-label { color: #666; font-size: 13px; }
        .info-value { font-weight: 500; font-size: 13px; color: #333; }

        .position-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .coord-box {
            text-align: center;
        }

        .coord-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .coord-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .intel-box {
            background: #fff8e1;
            border-left: 4px solid #f39c12;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .weapons-grid {
            display: grid;
            gap: 8px;
        }

        .weapon-item {
            background: #fee;
            border-radius: 6px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weapon-name { color: #c0392b; font-size: 12px; }
        .weapon-value { font-weight: 600; color: #333; font-size: 13px; }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 20px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .action-btn-primary {
            background: #e94560;
            color: white;
        }

        .action-btn-primary:hover { background: #d63850; }

        .action-btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .action-btn-secondary:hover { background: #eee; }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 24px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #eee;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }

        .timeline-item:last-child { padding-bottom: 0; }

        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e94560;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #e94560;
        }

        .timeline-dot.severity-high { background: #f39c12; box-shadow: 0 0 0 2px #f39c12; }
        .timeline-dot.severity-medium { background: #3498db; box-shadow: 0 0 0 2px #3498db; }
        .timeline-dot.severity-info { background: #95a5a6; box-shadow: 0 0 0 2px #95a5a6; }

        .timeline-date {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
        }

        .timeline-title {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .timeline-desc {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        /* Vessel list panel (left side) */
        .list-panel {
            position: absolute;
            top: 56px;
            left: 0;
            width: 320px;
            height: calc(100vh - 56px);
            background: white;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            z-index: 998;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .list-panel.active { transform: translateX(0); }

        .list-header {
            padding: 16px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-title {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .add-vessel-btn {
            background: #e94560;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .add-vessel-btn:hover { background: #d63850; }

        .vessel-list {
            flex: 1;
            overflow-y: auto;
        }

        .vessel-list-item {
            padding: 16px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: background 0.2s;
        }

        .vessel-list-item:hover { background: #f8f9fa; }
        .vessel-list-item.active { background: #fff0f3; border-left: 3px solid #e94560; }

        .vessel-list-icon {
            width: 40px; height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .vessel-list-icon.critical { background: rgba(233,69,96,0.1); color: #e94560; }
        .vessel-list-icon.high { background: rgba(243,156,18,0.1); color: #f39c12; }
        .vessel-list-icon.medium { background: rgba(52,152,219,0.1); color: #3498db; }
        .vessel-list-icon.low { background: rgba(39,174,96,0.1); color: #27ae60; }
        .vessel-list-icon.unknown { background: rgba(149,165,166,0.1); color: #95a5a6; }

        .vessel-list-info { flex: 1; min-width: 0; }
        .vessel-list-name { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 2px; }
        .vessel-list-meta { font-size: 12px; color: #666; }
        .vessel-list-status { font-size: 11px; color: #999; margin-top: 4px; }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 16px;
            width: 480px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 18px; font-weight: 600; color: #333; }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover { color: #333; }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #333; margin-bottom: 8px; }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #e94560;
        }

        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63850; }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-secondary:hover { background: #eee; }

        /* Ship marker styles */
        .ship-marker {
            width: 24px;
            height: 24px;
            transform-origin: center center;
        }

        .ship-marker svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* Leaflet customization */
        .leaflet-container { background: #1a1a2e; }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }

        .popup-content {
            padding: 16px;
        }

        .popup-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .popup-icon {
            width: 36px; height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-name { font-weight: 600; font-size: 15px; }
        .popup-type { font-size: 12px; color: #666; }

        .popup-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .popup-stat {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .popup-stat-value { font-weight: 600; font-size: 14px; }
        .popup-stat-label { font-size: 10px; color: #666; text-transform: uppercase; }

        .popup-btn {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
        }

        .popup-btn:hover { background: #d63850; }

        /* Map instructions overlay */
        .map-overlay {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26,26,46,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        .map-overlay.active { display: block; }

        @media (max-width: 768px) {
            .stats-bar { display: none; }
            .vessel-panel, .list-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="top-bar">
        <div class="logo">
            <div class="logo-icon">A</div>
            <span>Arsenal Tracker</span>
        </div>

        <div class="search-container">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" class="search-input" id="search-input" placeholder="Search vessels by name, MMSI, or IMO...">
            <div class="search-results" id="search-results"></div>
        </div>

        <div class="stats-bar">
            <div class="stat stat-critical">
                <div class="stat-value" id="stat-critical">0</div>
                <div class="stat-label">Critical</div>
            </div>
            <div class="stat stat-warning">
                <div class="stat-value" id="stat-alerts">0</div>
                <div class="stat-label">Alerts</div>
            </div>
            <div class="stat stat-info">
                <div class="stat-value" id="stat-vessels">0</div>
                <div class="stat-label">Vessels</div>
            </div>
            <div class="stat" style="color:#3498db">
                <div class="stat-value" id="stat-live">0</div>
                <div class="stat-label">Live</div>
            </div>
        </div>
    </div>

    <div class="map-controls">
        <button class="control-btn" id="toggle-list" title="Vessel List">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
        </button>
        <button class="control-btn" id="add-vessel-btn" title="Add Vessel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>
        <button class="control-btn" id="toggle-shipyards" title="Toggle Shipyards">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-3"/>
            </svg>
        </button>
        <button class="control-btn active" id="toggle-live" title="Toggle Live Vessels" style="background:#3498db;color:white;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
        </button>
        <button class="control-btn" id="draw-area-btn" title="Draw Streaming Area">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
            </svg>
        </button>
    </div>

    <div class="map-overlay" id="map-overlay">Click on map to set vessel position</div>

    <!-- Vessel List Panel -->
    <div class="list-panel" id="list-panel">
        <div class="list-header">
            <span class="list-title">Tracked Vessels</span>
            <button class="add-vessel-btn" onclick="openAddVesselModal()">+ Add</button>
        </div>
        <div class="vessel-list" id="vessel-list"></div>
    </div>

    <!-- Vessel Detail Panel -->
    <div class="vessel-panel" id="vessel-panel">
        <div id="vessel-panel-content"></div>
    </div>

    <!-- Add Vessel Modal -->
    <div class="modal-overlay" id="add-vessel-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add New Vessel</span>
                <button class="modal-close" onclick="closeModal('add-vessel-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Vessel Name *</label>
                    <input type="text" class="form-input" id="vessel-name" placeholder="e.g. ZHONG DA 79">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">MMSI</label>
                        <input type="text" class="form-input" id="vessel-mmsi" placeholder="9 digits">
                    </div>
                    <div class="form-group">
                        <label class="form-label">IMO</label>
                        <input type="text" class="form-input" id="vessel-imo" placeholder="7 digits">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Flag State</label>
                        <input type="text" class="form-input" id="vessel-flag" placeholder="e.g. China">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vessel Type</label>
                        <input type="text" class="form-input" id="vessel-type" placeholder="e.g. Container Feeder">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Classification</label>
                        <select class="form-select" id="vessel-classification">
                            <option value="monitoring">Monitoring</option>
                            <option value="suspected">Suspected</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Threat Level</label>
                        <select class="form-select" id="vessel-threat">
                            <option value="unknown">Unknown</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Intel Notes</label>
                    <textarea class="form-textarea" id="vessel-notes" placeholder="Intelligence notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-vessel-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="addVessel()">Add Vessel</button>
            </div>
        </div>
    </div>

    <!-- Draw Area Modal -->
    <div class="modal-overlay" id="area-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Streaming Area Selected</span>
                <button class="modal-close" onclick="closeModal('area-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background:#f5f5f5;padding:16px;border-radius:8px;font-family:monospace;font-size:13px">
                    <div>"bounding_box": {</div>
                    <div style="padding-left:20px">"lat_min": <span id="area-lat-min">0</span>,</div>
                    <div style="padding-left:20px">"lon_min": <span id="area-lon-min">0</span>,</div>
                    <div style="padding-left:20px">"lat_max": <span id="area-lat-max">0</span>,</div>
                    <div style="padding-left:20px">"lon_max": <span id="area-lon-max">0</span></div>
                    <div>}</div>
                </div>
                <button class="btn btn-primary" style="margin-top:16px;width:100%" onclick="applyAreaConfig()">Apply & Save Config</button>
                <button class="btn btn-secondary" style="margin-top:8px;width:100%" onclick="copyAreaConfig()">Copy to Clipboard</button>
                <p style="margin-top:12px;font-size:12px;color:#666">After applying, restart <code>stream_area.py</code> to use the new area.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('area-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- News Search Results Modal -->
    <div class="modal-overlay" id="news-modal">
        <div class="modal" style="width:600px;max-width:95vw">
            <div class="modal-header">
                <span class="modal-title" id="news-modal-title">News Results</span>
                <button class="modal-close" onclick="closeModal('news-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:70vh">
                <div style="margin-bottom:16px;display:flex;gap:8px">
                    <input type="text" class="form-input" id="news-search-query" placeholder="Search query..." style="flex:1">
                    <button class="btn btn-primary" onclick="executeNewsSearch()" style="white-space:nowrap">Search</button>
                </div>
                <div id="news-results">
                    <div style="text-align:center;padding:40px;color:#666">Enter vessel name and click Search</div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="mmsi-lookup-link" href="#" target="_blank" class="btn btn-secondary" style="margin-right:auto">Lookup MMSI</a>
                <button class="btn btn-secondary" onclick="closeModal('news-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Vessel Modal -->
    <div class="modal-overlay" id="edit-vessel-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Vessel</span>
                <button class="modal-close" onclick="closeModal('edit-vessel-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-vessel-id">
                <div class="form-group">
                    <label class="form-label">Vessel Name *</label>
                    <input type="text" class="form-input" id="edit-vessel-name" placeholder="e.g. ZHONG DA 79">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Flag State</label>
                        <input type="text" class="form-input" id="edit-vessel-flag" placeholder="e.g. China">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vessel Type</label>
                        <input type="text" class="form-input" id="edit-vessel-type" placeholder="e.g. Container Feeder">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Classification</label>
                        <select class="form-select" id="edit-vessel-classification">
                            <option value="monitoring">Monitoring</option>
                            <option value="suspected">Suspected</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Threat Level</label>
                        <select class="form-select" id="edit-vessel-threat">
                            <option value="unknown">Unknown</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Intel Notes</label>
                    <textarea class="form-textarea" id="edit-vessel-notes" placeholder="Intelligence notes..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Vessel Photo</label>
                    <div id="edit-vessel-photo-preview" style="margin-bottom:8px"></div>
                    <input type="file" id="edit-vessel-photo" accept="image/*" style="display:none" onchange="previewPhoto(this)">
                    <button type="button" class="btn btn-secondary" style="width:100%" onclick="document.getElementById('edit-vessel-photo').click()">Choose Photo</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-vessel-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveVesselEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Update Position Modal -->
    <div class="modal-overlay" id="position-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Update Position</span>
                <button class="modal-close" onclick="closeModal('position-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Latitude *</label>
                        <input type="number" step="0.0001" class="form-input" id="position-lat">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Longitude *</label>
                        <input type="number" step="0.0001" class="form-input" id="position-lon">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Heading (0-360Â°)</label>
                        <input type="number" class="form-input" id="position-heading">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Speed (knots)</label>
                        <input type="number" step="0.1" class="form-input" id="position-speed">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-select" id="position-source">
                        <option value="manual">Manual</option>
                        <option value="ais">AIS</option>
                        <option value="satellite">Satellite</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('position-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePosition()">Save</button>
            </div>
        </div>
    </div>

    <!-- Track Live Vessel Modal -->
    <div class="modal-overlay" id="track-vessel-modal">
        <div class="modal" style="width:550px;max-width:95vw">
            <div class="modal-header">
                <span class="modal-title">Track Live Vessel</span>
                <button class="modal-close" onclick="closeModal('track-vessel-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto">
                <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-size:12px;color:#666">MMSI</div>
                        <div style="font-size:18px;font-weight:600" id="track-vessel-mmsi">-</div>
                    </div>
                    <a id="track-vessel-lookup" href="#" target="_blank" class="btn btn-secondary" style="font-size:12px">Lookup on VesselFinder</a>
                </div>

                <div style="font-weight:600;margin-bottom:8px;color:#333">Basic Info</div>
                <div class="form-group">
                    <label class="form-label">Vessel Name *</label>
                    <input type="text" class="form-input" id="track-vessel-name" placeholder="Enter vessel name from VesselFinder">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ship Type</label>
                        <input type="text" class="form-input" id="track-vessel-type" placeholder="e.g. Container Feeder">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Flag</label>
                        <input type="text" class="form-input" id="track-vessel-flag" placeholder="e.g. China">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">IMO Number</label>
                        <input type="text" class="form-input" id="track-vessel-imo" placeholder="e.g. 9429625">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Length (m)</label>
                        <input type="number" class="form-input" id="track-vessel-length" placeholder="e.g. 97">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Classification</label>
                        <select class="form-select" id="track-vessel-classification">
                            <option value="monitoring">Monitoring</option>
                            <option value="suspected">Suspected</option>
                            <option value="confirmed">Confirmed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Threat Level</label>
                        <select class="form-select" id="track-vessel-threat">
                            <option value="unknown">Unknown</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>

                <div style="font-weight:600;margin:16px 0 8px;color:#333">Weapons Configuration</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">VLS Cells</label>
                        <input type="number" class="form-input" id="track-vessel-vls" placeholder="e.g. 60">
                    </div>
                    <div class="form-group">
                        <label class="form-label">VLS Type</label>
                        <input type="text" class="form-input" id="track-vessel-vls-type" placeholder="e.g. Containerized">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">CIWS</label>
                        <input type="text" class="form-input" id="track-vessel-ciws" placeholder="e.g. Type 1130 30mm">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Decoys</label>
                        <input type="text" class="form-input" id="track-vessel-decoys" placeholder="e.g. Type 726">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Possible Missiles (comma-separated)</label>
                    <input type="text" class="form-input" id="track-vessel-missiles" placeholder="e.g. CJ-10, YJ-18, YJ-21">
                </div>

                <div style="font-weight:600;margin:16px 0 8px;color:#333">Intelligence</div>
                <div class="form-group">
                    <label class="form-label">Intel Notes</label>
                    <textarea class="form-textarea" id="track-vessel-notes" rows="4" placeholder="Paste vessel details, observations, sources..."></textarea>
                </div>
                <input type="hidden" id="track-vessel-data">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('track-vessel-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmTrackVessel()">Track Vessel</button>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal-overlay" id="intel-modal">
        <div class="modal" style="width:700px;max-width:95vw">
            <div class="modal-header">
                <span class="modal-title">AI Intelligence Analysis</span>
                <button class="modal-close" onclick="closeModal('intel-modal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto">
                <div id="intel-loading" style="text-align:center;padding:40px;color:#666">
                    <div style="font-size:24px;margin-bottom:16px">Analyzing vessel...</div>
                    <div style="font-size:14px">Generating search queries, scanning news sources, running AI assessment</div>
                </div>
                <div id="intel-error" style="display:none;text-align:center;padding:40px;color:#e94560"></div>
                <div id="intel-results" style="display:none">
                    <div id="intel-bluf" style="background:#1a1a2e;color:#fff;padding:16px;border-radius:8px;margin-bottom:16px"></div>
                    <div id="intel-news" style="margin-bottom:16px"></div>
                    <div id="intel-analysis" style="background:#f8f9fa;padding:16px;border-radius:8px;white-space:pre-wrap;font-size:13px;line-height:1.6"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('intel-modal')">Close</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API = '/api';
        let map, vessels = [], shipyards = [];
        let vesselMarkers = {}, shipyardMarkers = [], shipyardCircles = [];
        let liveVesselMarkers = {}, liveVessels = [];
        let selectedVessel = null, trackLine = null;
        let mapClickMode = false, showShipyards = true, showLiveVessels = true;
        let drawingArea = false, areaStartPoint = null, areaRectangle = null;

        // Ship SVG icons by vessel type
        const SHIP_ICONS = {
            container: `<path d="M4 17h16v2H4v-2zm0-4h16v2H4v-2zm2-3h12l-1-5H7l-1 5zm1-7h10v2H7V3z"/>`,
            tanker: `<path d="M4 16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-2H4v2zm16-6l-2-5H6L4 10v2h16v-2zM7 6h10v2H7V6z"/>`,
            cargo: `<path d="M3 17h18v2H3v-2zm1-5h16l-1.5-6h-13L4 12zm3-8h10v3H7V4z"/>`,
            passenger: `<path d="M12 3L4 10v2h2v6h12v-6h2v-2L12 3zm0 12h-2v-3h4v3h-2z"/>`,
            fishing: `<path d="M12 4L8 8v2l4-2 4 2V8l-4-4zm-6 8l2 6h8l2-6H6zm6 1a1.5 1.5 0 110 3 1.5 1.5 0 010-3z"/>`,
            tug: `<path d="M6 14l-2 4h16l-2-4H6zm1-2h10l1-4H6l1 4zm4-6h2v3h-2V6z"/>`,
            military: `<path d="M12 2l-8 8v2h3v6h10v-6h3v-2l-8-8zm0 4l4 4h-8l4-4zm-2 6h4v3h-4v-3z"/>`,
            default: `<path d="M12 2L4 19h16L12 2z"/>`
        };

        function getShipType(vesselType) {
            if (!vesselType) return 'default';
            const type = vesselType.toLowerCase();
            if (type.includes('container') || type.includes('feeder')) return 'container';
            if (type.includes('tanker') || type.includes('oil') || type.includes('chemical') || type.includes('lng') || type.includes('lpg')) return 'tanker';
            if (type.includes('cargo') || type.includes('bulk') || type.includes('general')) return 'cargo';
            if (type.includes('passenger') || type.includes('cruise') || type.includes('ferry') || type.includes('roro')) return 'passenger';
            if (type.includes('fish') || type.includes('trawl')) return 'fishing';
            if (type.includes('tug') || type.includes('pilot') || type.includes('supply')) return 'tug';
            if (type.includes('military') || type.includes('naval') || type.includes('patrol') || type.includes('coast guard')) return 'military';
            return 'default';
        }

        function createShipIcon(color, heading = 0, vesselType = null) {
            const shipType = getShipType(vesselType);
            const iconPath = SHIP_ICONS[shipType] || SHIP_ICONS.default;
            const svg = `<svg viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg">
                ${iconPath}
                <style>path{stroke:white;stroke-width:0.5}</style>
            </svg>`;
            return L.divIcon({
                html: `<div class="ship-marker" style="transform: rotate(${heading}deg)">${svg}</div>`,
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        function getThreatColor(level) {
            return { critical: '#e94560', high: '#f39c12', medium: '#3498db', low: '#27ae60', unknown: '#95a5a6' }[level] || '#95a5a6';
        }

        // Initialize map
        function initMap() {
            map = L.map('map', { center: [25, 120], zoom: 5, zoomControl: false });
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);

            // Re-render live vessels when map moves (with debounce)
            let moveTimeout;
            map.on('moveend', () => {
                clearTimeout(moveTimeout);
                moveTimeout = setTimeout(renderLiveVessels, 100);
            });

            map.on('click', e => {
                if (mapClickMode && selectedVessel) {
                    document.getElementById('position-lat').value = e.latlng.lat.toFixed(4);
                    document.getElementById('position-lon').value = e.latlng.lng.toFixed(4);
                    openModal('position-modal');
                    setMapClickMode(false);
                }
            });

            // Drawing area handlers
            map.on('mousedown', e => {
                if (drawingArea && !areaStartPoint) {
                    areaStartPoint = e.latlng;
                    map.dragging.disable();
                }
            });

            map.on('mousemove', e => {
                if (drawingArea && areaStartPoint) {
                    const bounds = L.latLngBounds(areaStartPoint, e.latlng);
                    if (areaRectangle) {
                        areaRectangle.setBounds(bounds);
                    } else {
                        areaRectangle = L.rectangle(bounds, {
                            color: '#e94560',
                            weight: 2,
                            fillOpacity: 0.2
                        }).addTo(map);
                    }
                }
            });

            map.on('mouseup', e => {
                if (drawingArea && areaStartPoint) {
                    const bounds = L.latLngBounds(areaStartPoint, e.latlng);
                    map.dragging.enable();
                    stopDrawArea();
                    if (bounds.getNorthEast().lat !== bounds.getSouthWest().lat) {
                        showAreaModal(bounds);
                    }
                }
            });
        }

        // API helpers
        async function api(endpoint, options = {}) {
            const res = await fetch(API + endpoint, options);
            return res.json();
        }

        async function post(endpoint, data) {
            return api(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // Load data
        async function loadData() {
            const [stats, vesselsData, shipyardsData] = await Promise.all([
                api('/stats'),
                api('/vessels'),
                api('/shipyards')
            ]);

            vessels = vesselsData || [];
            shipyards = shipyardsData || [];

            document.getElementById('stat-critical').textContent = stats?.critical_threats || 0;
            document.getElementById('stat-alerts').textContent = stats?.active_alerts || 0;
            document.getElementById('stat-vessels').textContent = stats?.total_vessels || 0;

            renderVesselList();
            renderVesselMarkers();
            renderShipyards();
        }

        function renderVesselList() {
            const list = document.getElementById('vessel-list');
            if (!vessels.length) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:#999">No vessels tracked</div>';
                return;
            }

            list.innerHTML = vessels.map(v => `
                <div class="vessel-list-item ${selectedVessel === v.id ? 'active' : ''}" onclick="selectVessel(${v.id})">
                    <div class="vessel-list-icon ${v.threat_level}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L4 19h16L12 2z"/>
                        </svg>
                    </div>
                    <div class="vessel-list-info">
                        <div class="vessel-list-name">${v.name}</div>
                        <div class="vessel-list-meta">${v.flag_state || 'Unknown'} â¢ ${v.vessel_type || 'Unknown'}</div>
                        <div class="vessel-list-status">${v.last_lat ? `${v.last_lat.toFixed(2)}Â°, ${v.last_lon.toFixed(2)}Â°` : 'No position'}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderVesselMarkers() {
            Object.values(vesselMarkers).forEach(m => map.removeLayer(m));
            vesselMarkers = {};

            vessels.forEach(v => {
                if (!v.last_lat || !v.last_lon) return;

                const color = getThreatColor(v.threat_level);
                const heading = v.last_heading || 0;
                const marker = L.marker([v.last_lat, v.last_lon], {
                    icon: createShipIcon(color, heading, v.vessel_type)
                }).addTo(map);

                marker.bindPopup(() => createPopup(v), { maxWidth: 300 });
                marker.on('click', () => selectVessel(v.id));
                vesselMarkers[v.id] = marker;
            });
        }

        function createPopup(v) {
            return `
                <div class="popup-content">
                    <div class="popup-header">
                        <div class="popup-icon" style="background:${getThreatColor(v.threat_level)}20;color:${getThreatColor(v.threat_level)}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 19h16L12 2z"/></svg>
                        </div>
                        <div>
                            <div class="popup-name">${v.name}</div>
                            <div class="popup-type">${v.flag_state || ''} ${v.vessel_type || ''}</div>
                        </div>
                    </div>
                    <div class="popup-stats">
                        <div class="popup-stat">
                            <div class="popup-stat-value">${v.last_lat?.toFixed(4) || '-'}</div>
                            <div class="popup-stat-label">Latitude</div>
                        </div>
                        <div class="popup-stat">
                            <div class="popup-stat-value">${v.last_lon?.toFixed(4) || '-'}</div>
                            <div class="popup-stat-label">Longitude</div>
                        </div>
                    </div>
                    <button class="popup-btn" onclick="selectVessel(${v.id})">View Details</button>
                </div>
            `;
        }

        function renderShipyards() {
            shipyardMarkers.forEach(m => map.removeLayer(m));
            shipyardCircles.forEach(c => map.removeLayer(c));
            shipyardMarkers = [];
            shipyardCircles = [];

            if (!showShipyards) return;

            shipyards.forEach(s => {
                const marker = L.circleMarker([s.latitude, s.longitude], {
                    radius: 6, fillColor: '#f39c12', color: '#fff', weight: 2, fillOpacity: 0.8
                }).addTo(map);
                marker.bindPopup(`<b>${s.name}</b><br>${s.location}`);
                shipyardMarkers.push(marker);

                const circle = L.circle([s.latitude, s.longitude], {
                    radius: s.geofence_radius_km * 1000,
                    color: '#f39c12', fillColor: '#f39c12', fillOpacity: 0.1, weight: 1, dashArray: '4'
                }).addTo(map);
                shipyardCircles.push(circle);
            });
        }

        // Load live vessels from streaming API
        async function loadLiveVessels() {
            try {
                const data = await api('/live-vessels');
                liveVessels = data.vessels || [];
                renderLiveVessels();
                const liveCount = document.getElementById('stat-live');
                if (liveCount) liveCount.textContent = liveVessels.length;
            } catch(e) {
                console.log('No live vessel data available');
            }
        }

        // Render live vessels on map
        const MAX_LIVE_MARKERS = 500; // Limit to prevent browser lag

        function renderLiveVessels() {
            Object.values(liveVesselMarkers).forEach(m => map.removeLayer(m));
            liveVesselMarkers = {};

            if (!showLiveVessels) return;

            // Filter to only vessels in current viewport
            const bounds = map.getBounds();
            const inView = liveVessels.filter(v => {
                if (!v.lat || !v.lon) return false;
                return bounds.contains([v.lat, v.lon]);
            });

            // Limit number of markers to prevent lag
            const toRender = inView.slice(0, MAX_LIVE_MARKERS);

            // Update live count to show filtered/total
            const liveCount = document.getElementById('stat-live');
            if (liveCount) {
                liveCount.textContent = inView.length > MAX_LIVE_MARKERS
                    ? `${MAX_LIVE_MARKERS}/${inView.length}`
                    : `${inView.length}/${liveVessels.length}`;
            }

            toRender.forEach(v => {
                const color = '#3498db'; // Blue for live vessels
                const marker = L.marker([v.lat, v.lon], {
                    icon: createShipIcon(color, v.heading || v.course || 0, v.ship_type)
                }).addTo(map);
                marker.bindPopup(`<div class="popup-content">
                    <div class="popup-header">
                        <div class="popup-icon" style="background:#3498db20;color:#3498db">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 19h16L12 2z"/></svg>
                        </div>
                        <div>
                            <div class="popup-name">${v.name || 'MMSI ' + v.mmsi}</div>
                            <div class="popup-type">${v.ship_type || 'Unknown'} ${v.flag || ''}</div>
                        </div>
                    </div>
                    <div class="popup-stats">
                        <div class="popup-stat"><div class="popup-stat-value">${v.lat.toFixed(4)}</div><div class="popup-stat-label">Lat</div></div>
                        <div class="popup-stat"><div class="popup-stat-value">${v.lon.toFixed(4)}</div><div class="popup-stat-label">Lon</div></div>
                        <div class="popup-stat"><div class="popup-stat-value">${v.speed ? v.speed.toFixed(1) : '-'}</div><div class="popup-stat-label">Knots</div></div>
                    </div>
                    <div style="font-size:11px;color:#666;margin-top:8px">MMSI: ${v.mmsi}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
                        <button class="popup-btn" style="margin:0;background:#3498db" onclick="searchVesselNews('${v.name || ''}', '${v.mmsi}')">Search News</button>
                        <button class="popup-btn" style="margin:0;background:#27ae60" onclick="trackLiveVessel(${JSON.stringify(v).replace(/"/g, '&quot;')})">Track Vessel</button>
                    </div>
                </div>`, { maxWidth: 300 });
                liveVesselMarkers[v.mmsi] = marker;
            });
        }

        // Select vessel
        async function selectVessel(id) {
            selectedVessel = id;
            const v = vessels.find(x => x.id === id);
            if (!v) return;

            // Update list selection
            document.querySelectorAll('.vessel-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.vessel-list-item[onclick="selectVessel(${id})"]`)?.classList.add('active');

            // Center map
            if (v.last_lat && v.last_lon) {
                map.setView([v.last_lat, v.last_lon], 8);
            }

            // Load details
            const [events, track, osint] = await Promise.all([
                api(`/vessels/${id}/events`),
                api(`/vessels/${id}/track?days=365`),
                api(`/osint?vessel_id=${id}`)
            ]);

            // Draw track
            if (trackLine) map.removeLayer(trackLine);
            if (track?.length > 1) {
                trackLine = L.polyline(track.map(p => [p.latitude, p.longitude]), {
                    color: getThreatColor(v.threat_level), weight: 2, opacity: 0.7, dashArray: '6'
                }).addTo(map);
            }

            renderVesselPanel(v, events, osint);
            document.getElementById('vessel-panel').classList.add('active');
        }

        function renderVesselPanel(v, events, osint) {
            let weapons = {};
            try { weapons = JSON.parse(v.weapons_config || '{}'); } catch(e) {}

            document.getElementById('vessel-panel-content').innerHTML = `
                <div class="panel-header">
                    <button class="panel-close" onclick="closeVesselPanel()">&times;</button>
                    <div class="vessel-icon-large" style="background:${getThreatColor(v.threat_level)}20;color:${getThreatColor(v.threat_level)}">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 19h16L12 2z"/></svg>
                    </div>
                    <div class="vessel-name">${v.name}</div>
                    <div class="vessel-type">${v.flag_state || ''} â¢ ${v.vessel_type || 'Unknown Type'}</div>
                    <div class="threat-indicator threat-${v.threat_level}">${v.threat_level}</div>
                </div>

                ${v.photo_url ? `
                <div class="panel-section" style="padding:0">
                    <img src="${v.photo_url}" style="width:100%;max-height:200px;object-fit:cover" alt="Vessel photo">
                </div>` : ''}

                <div class="panel-section">
                    <div class="section-title">Position</div>
                    <div class="position-display">
                        <div class="coord-box">
                            <div class="coord-label">Latitude</div>
                            <div class="coord-value">${v.last_lat?.toFixed(4) || '-'}</div>
                        </div>
                        <div class="coord-box">
                            <div class="coord-label">Longitude</div>
                            <div class="coord-value">${v.last_lon?.toFixed(4) || '-'}</div>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="section-title">Details</div>
                    <div class="info-row"><span class="info-label">MMSI</span><span class="info-value">${v.mmsi || '-'}</span></div>
                    <div class="info-row"><span class="info-label">IMO</span><span class="info-value">${v.imo || '-'}</span></div>
                    <div class="info-row"><span class="info-label">Classification</span><span class="info-value">${v.classification || '-'}</span></div>
                    <div class="info-row"><span class="info-label">Length</span><span class="info-value">${v.length_m ? v.length_m + 'm' : '-'}</span></div>
                </div>

                ${v.intel_notes ? `
                <div class="panel-section">
                    <div class="section-title">Intelligence</div>
                    <div class="intel-box">${v.intel_notes}</div>
                </div>` : ''}

                ${Object.keys(weapons).length ? `
                <div class="panel-section">
                    <div class="section-title">Weapons</div>
                    <div class="weapons-grid">
                        ${weapons.vls_cells ? `<div class="weapon-item"><span class="weapon-name">VLS Cells</span><span class="weapon-value">${weapons.vls_cells}</span></div>` : ''}
                        ${weapons.ciws ? `<div class="weapon-item"><span class="weapon-name">CIWS</span><span class="weapon-value">${weapons.ciws}</span></div>` : ''}
                        ${weapons.decoys ? `<div class="weapon-item"><span class="weapon-name">Decoys</span><span class="weapon-value">${weapons.decoys}</span></div>` : ''}
                        ${weapons.possible_missiles?.length ? `<div class="weapon-item"><span class="weapon-name">Missiles</span><span class="weapon-value">${weapons.possible_missiles.join(', ')}</span></div>` : ''}
                    </div>
                </div>` : ''}

                <div class="action-buttons">
                    <button class="action-btn action-btn-primary" onclick="runVesselIntel(${v.id})">AI Analysis</button>
                    <button class="action-btn action-btn-secondary" onclick="openPositionModal()">Update Position</button>
                    <button class="action-btn action-btn-secondary" onclick="openEditVesselModal(${v.id})">Edit Vessel</button>
                    <button class="action-btn action-btn-secondary" style="color:#e94560" onclick="deleteVessel(${v.id})">Delete</button>
                </div>

                ${events?.length ? `
                <div class="panel-section">
                    <div class="section-title">Timeline</div>
                    <div class="timeline">
                        ${events.slice(0, 8).map(e => `
                            <div class="timeline-item">
                                <div class="timeline-dot severity-${e.severity === 'critical' ? 'critical' : e.severity === 'high' ? 'high' : e.severity === 'medium' ? 'medium' : 'info'}"></div>
                                <div class="timeline-date">${new Date(e.event_date).toLocaleDateString()}</div>
                                <div class="timeline-title">${e.title}</div>
                                ${e.description ? `<div class="timeline-desc">${e.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>` : ''}

                ${osint?.length ? `
                <div class="panel-section">
                    <div class="section-title">OSINT Reports</div>
                    ${osint.map(r => `
                        <div style="margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:8px">
                            <div style="font-size:11px;color:#e94560;text-transform:uppercase;margin-bottom:4px">${r.source_name}</div>
                            <a href="${r.source_url}" target="_blank" style="font-weight:500;color:#333;text-decoration:none">${r.title}</a>
                            <div style="font-size:12px;color:#666;margin-top:4px">${r.summary || ''}</div>
                        </div>
                    `).join('')}
                </div>` : ''}
            `;
        }

        function closeVesselPanel() {
            document.getElementById('vessel-panel').classList.remove('active');
            selectedVessel = null;
        }

        // Search
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', e => {
            const q = e.target.value.toLowerCase().trim();
            if (!q) { searchResults.classList.remove('active'); return; }

            const matches = vessels.filter(v =>
                v.name.toLowerCase().includes(q) ||
                (v.mmsi && v.mmsi.includes(q)) ||
                (v.imo && v.imo.includes(q))
            ).slice(0, 5);

            if (!matches.length) { searchResults.classList.remove('active'); return; }

            searchResults.innerHTML = matches.map(v => `
                <div class="search-result-item" onclick="selectVessel(${v.id}); searchResults.classList.remove('active'); searchInput.value = '';">
                    <div class="result-icon" style="background:${getThreatColor(v.threat_level)}20;color:${getThreatColor(v.threat_level)}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 19h16L12 2z"/></svg>
                    </div>
                    <div class="result-info">
                        <div class="result-name">${v.name}</div>
                        <div class="result-meta">${v.flag_state || ''} ${v.mmsi ? 'â¢ ' + v.mmsi : ''}</div>
                    </div>
                </div>
            `).join('');
            searchResults.classList.add('active');
        });

        searchInput.addEventListener('blur', () => setTimeout(() => searchResults.classList.remove('active'), 200));

        // Modals
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function openAddVesselModal() {
            ['vessel-name','vessel-mmsi','vessel-imo','vessel-flag','vessel-type','vessel-notes'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('vessel-classification').value = 'monitoring';
            document.getElementById('vessel-threat').value = 'unknown';
            openModal('add-vessel-modal');
        }

        function openPositionModal() {
            const v = vessels.find(x => x.id === selectedVessel);
            document.getElementById('position-lat').value = v?.last_lat || '';
            document.getElementById('position-lon').value = v?.last_lon || '';
            document.getElementById('position-heading').value = '';
            document.getElementById('position-speed').value = '';
            openModal('position-modal');
        }

        function setMapClickMode(enabled) {
            mapClickMode = enabled;
            document.getElementById('map-overlay').classList.toggle('active', enabled);
            document.getElementById('map').style.cursor = enabled ? 'crosshair' : '';
        }

        function pickOnMap() {
            setMapClickMode(true);
            document.getElementById('vessel-panel').classList.remove('active');
        }

        async function addVessel() {
            const name = document.getElementById('vessel-name').value.trim();
            if (!name) return alert('Vessel name required');

            await post('/vessels', {
                name,
                mmsi: document.getElementById('vessel-mmsi').value.trim() || null,
                imo: document.getElementById('vessel-imo').value.trim() || null,
                flag_state: document.getElementById('vessel-flag').value.trim() || null,
                vessel_type: document.getElementById('vessel-type').value.trim() || null,
                classification: document.getElementById('vessel-classification').value,
                threat_level: document.getElementById('vessel-threat').value,
                intel_notes: document.getElementById('vessel-notes').value.trim() || null
            });

            closeModal('add-vessel-modal');
            await loadData();
        }

        async function savePosition() {
            const lat = parseFloat(document.getElementById('position-lat').value);
            const lon = parseFloat(document.getElementById('position-lon').value);
            if (isNaN(lat) || isNaN(lon)) return alert('Valid coordinates required');

            await post(`/vessels/${selectedVessel}/position`, {
                latitude: lat,
                longitude: lon,
                heading: parseFloat(document.getElementById('position-heading').value) || null,
                speed_knots: parseFloat(document.getElementById('position-speed').value) || null,
                source: document.getElementById('position-source').value
            });

            closeModal('position-modal');
            await loadData();
            selectVessel(selectedVessel);
        }

        // Search news for a vessel
        async function searchVesselNews(name, mmsi) {
            const query = name || '';
            document.getElementById('news-modal-title').textContent = `News Search: ${name || 'MMSI ' + mmsi}`;
            document.getElementById('news-search-query').value = query;
            document.getElementById('mmsi-lookup-link').href = `https://www.vesselfinder.com/vessels?name=${mmsi}`;
            document.getElementById('news-results').innerHTML = name
                ? '<div style="text-align:center;padding:40px;color:#666">Click Search to find news articles</div>'
                : '<div style="text-align:center;padding:20px;color:#666"><strong>No vessel name in AIS data</strong><br><br>1. Click <b>"Lookup MMSI"</b> below<br>2. Find the vessel name on VesselFinder<br>3. Copy the name and paste it in the search box above<br>4. Click Search</div>';
            openModal('news-modal');

            // Auto-search if we have a name
            if (name) {
                executeNewsSearch();
            }
        }

        // Execute news search with current query
        async function executeNewsSearch() {
            const query = document.getElementById('news-search-query').value.trim();
            if (!query) {
                document.getElementById('news-results').innerHTML = '<div style="text-align:center;padding:40px;color:#e94560">Please enter a search query</div>';
                return;
            }

            document.getElementById('news-results').innerHTML = '<div style="text-align:center;padding:40px;color:#666">Searching Google News...</div>';

            try {
                const result = await post('/search-news', { query: query + ' ship vessel', max_results: 10 });

                if (result.error) {
                    document.getElementById('news-results').innerHTML = `<div style="text-align:center;padding:40px;color:#e94560">${result.error}</div>`;
                    return;
                }

                if (!result.articles || result.articles.length === 0) {
                    document.getElementById('news-results').innerHTML = '<div style="text-align:center;padding:40px;color:#666">No news articles found.<br><br>Try a different search term.</div>';
                    return;
                }

                document.getElementById('news-results').innerHTML = result.articles.map(a => `
                    <div style="padding:16px;border-bottom:1px solid #eee">
                        <a href="${a.url}" target="_blank" style="font-weight:600;color:#333;text-decoration:none;font-size:14px">${a.title}</a>
                        <div style="font-size:12px;color:#666;margin-top:4px">${a.source} â¢ ${a.published}</div>
                        ${a.description ? `<div style="font-size:13px;color:#444;margin-top:8px">${a.description}</div>` : ''}
                    </div>
                `).join('');

            } catch (e) {
                document.getElementById('news-results').innerHTML = `<div style="text-align:center;padding:40px;color:#e94560">Search failed: ${e.message}</div>`;
            }
        }

        // Draw streaming area
        function startDrawArea() {
            drawingArea = true;
            areaStartPoint = null;
            if (areaRectangle) {
                map.removeLayer(areaRectangle);
                areaRectangle = null;
            }
            document.getElementById('draw-area-btn').classList.add('active');
            document.getElementById('draw-area-btn').style.background = '#e94560';
            document.getElementById('draw-area-btn').style.color = 'white';
            document.getElementById('map').style.cursor = 'crosshair';
            document.getElementById('map-overlay').textContent = 'Click and drag to draw streaming area';
            document.getElementById('map-overlay').classList.add('active');
        }

        function stopDrawArea() {
            drawingArea = false;
            areaStartPoint = null;
            document.getElementById('draw-area-btn').classList.remove('active');
            document.getElementById('draw-area-btn').style.background = '';
            document.getElementById('draw-area-btn').style.color = '';
            document.getElementById('map').style.cursor = '';
            document.getElementById('map-overlay').classList.remove('active');
        }

        function showAreaModal(bounds) {
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();
            document.getElementById('area-lat-min').textContent = sw.lat.toFixed(2);
            document.getElementById('area-lon-min').textContent = sw.lng.toFixed(2);
            document.getElementById('area-lat-max').textContent = ne.lat.toFixed(2);
            document.getElementById('area-lon-max').textContent = ne.lng.toFixed(2);
            openModal('area-modal');
        }

        function copyAreaConfig() {
            const config = `"bounding_box": {
  "lat_min": ${document.getElementById('area-lat-min').textContent},
  "lon_min": ${document.getElementById('area-lon-min').textContent},
  "lat_max": ${document.getElementById('area-lat-max').textContent},
  "lon_max": ${document.getElementById('area-lon-max').textContent}
}`;
            navigator.clipboard.writeText(config).then(() => {
                alert('Copied to clipboard! Paste into ais_config.json');
            });
        }

        async function applyAreaConfig() {
            const data = {
                lat_min: parseFloat(document.getElementById('area-lat-min').textContent),
                lon_min: parseFloat(document.getElementById('area-lon-min').textContent),
                lat_max: parseFloat(document.getElementById('area-lat-max').textContent),
                lon_max: parseFloat(document.getElementById('area-lon-max').textContent),
                description: 'Custom area drawn on map'
            };

            try {
                const result = await post('/config/bounding-box', data);
                if (result.error) {
                    alert('Failed to save: ' + result.error);
                } else {
                    alert('Config saved! Restart stream_area.py to apply the new area.');
                    closeModal('area-modal');
                }
            } catch (e) {
                alert('Failed to save config: ' + e.message);
            }
        }

        // Photo preview for edit modal
        function previewPhoto(input) {
            const preview = document.getElementById('edit-vessel-photo-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:150px;border-radius:8px;border:1px solid #ddd">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Upload vessel photo
        async function uploadVesselPhoto(vesselId) {
            const input = document.getElementById('edit-vessel-photo');
            if (!input.files || !input.files[0]) return null;

            const file = input.files[0];
            const reader = new FileReader();

            return new Promise((resolve, reject) => {
                reader.onload = async function(e) {
                    try {
                        const result = await post(`/vessels/${vesselId}/photo`, {
                            photo: e.target.result,
                            filename: file.name
                        });
                        resolve(result);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('draw-area-btn').addEventListener('click', () => {
            if (drawingArea) {
                stopDrawArea();
            } else {
                startDrawArea();
            }
        });

        // Track a live vessel - open modal to enter details
        function trackLiveVessel(vesselData) {
            const mmsi = vesselData.mmsi;
            document.getElementById('track-vessel-mmsi').textContent = mmsi;
            document.getElementById('track-vessel-lookup').href = `https://www.vesselfinder.com/vessels?name=${mmsi}`;
            // Basic info
            document.getElementById('track-vessel-name').value = vesselData.name && !vesselData.name.startsWith('MMSI') ? vesselData.name : '';
            document.getElementById('track-vessel-type').value = vesselData.ship_type || '';
            document.getElementById('track-vessel-flag').value = vesselData.flag || '';
            document.getElementById('track-vessel-imo').value = vesselData.imo || '';
            document.getElementById('track-vessel-length').value = '';
            document.getElementById('track-vessel-classification').value = 'monitoring';
            document.getElementById('track-vessel-threat').value = 'unknown';
            // Weapons
            document.getElementById('track-vessel-vls').value = '';
            document.getElementById('track-vessel-vls-type').value = '';
            document.getElementById('track-vessel-ciws').value = '';
            document.getElementById('track-vessel-decoys').value = '';
            document.getElementById('track-vessel-missiles').value = '';
            // Intel
            document.getElementById('track-vessel-notes').value = '';
            document.getElementById('track-vessel-data').value = JSON.stringify(vesselData);
            openModal('track-vessel-modal');
        }

        // Confirm tracking after user fills in details
        async function confirmTrackVessel() {
            const vesselData = JSON.parse(document.getElementById('track-vessel-data').value);
            const name = document.getElementById('track-vessel-name').value.trim();

            if (!name) {
                alert('Please enter the vessel name (look it up on VesselFinder)');
                return;
            }

            // Update vessel data with user input
            vesselData.name = name;
            vesselData.ship_type = document.getElementById('track-vessel-type').value.trim() || vesselData.ship_type;
            vesselData.flag = document.getElementById('track-vessel-flag').value.trim() || vesselData.flag;
            vesselData.imo = document.getElementById('track-vessel-imo').value.trim() || null;
            vesselData.length_m = parseFloat(document.getElementById('track-vessel-length').value) || null;
            vesselData.classification = document.getElementById('track-vessel-classification').value;
            vesselData.threat_level = document.getElementById('track-vessel-threat').value;
            vesselData.intel_notes = document.getElementById('track-vessel-notes').value.trim() || null;

            // Build weapons config
            const vls = document.getElementById('track-vessel-vls').value;
            const vlsType = document.getElementById('track-vessel-vls-type').value.trim();
            const ciws = document.getElementById('track-vessel-ciws').value.trim();
            const decoys = document.getElementById('track-vessel-decoys').value.trim();
            const missiles = document.getElementById('track-vessel-missiles').value.trim();

            if (vls || vlsType || ciws || decoys || missiles) {
                vesselData.weapons_config = {};
                if (vls) vesselData.weapons_config.vls_cells = parseInt(vls);
                if (vlsType) vesselData.weapons_config.vls_type = vlsType;
                if (ciws) vesselData.weapons_config.ciws = ciws;
                if (decoys) vesselData.weapons_config.decoys = decoys;
                if (missiles) vesselData.weapons_config.possible_missiles = missiles.split(',').map(m => m.trim());
            }

            try {
                const result = await post('/track-vessel', vesselData);

                if (result.error) {
                    alert(result.error);
                    if (result.vessel_id) {
                        closeModal('track-vessel-modal');
                        selectVessel(result.vessel_id);
                    }
                    return;
                }

                closeModal('track-vessel-modal');
                alert(`Vessel "${result.name}" added to tracking!`);
                await loadData();
                selectVessel(result.id);

            } catch (e) {
                alert('Failed to track vessel: ' + e.message);
            }
        }

        // Run AI-powered vessel intelligence analysis
        async function runVesselIntel(vesselId) {
            const v = vessels.find(x => x.id === vesselId);
            if (!v) return;

            // Show modal with loading state
            document.getElementById('intel-loading').style.display = 'block';
            document.getElementById('intel-error').style.display = 'none';
            document.getElementById('intel-results').style.display = 'none';
            openModal('intel-modal');

            try {
                const vesselData = {
                    name: v.name,
                    mmsi: v.mmsi,
                    imo: v.imo,
                    vessel_type: v.vessel_type,
                    flag_state: v.flag_state,
                    length_m: v.length_m,
                    classification: v.classification,
                    threat_level: v.threat_level,
                    intel_notes: v.intel_notes
                };

                const result = await post('/vessel-intel', { vessel: vesselData });

                document.getElementById('intel-loading').style.display = 'none';

                if (result.error) {
                    document.getElementById('intel-error').textContent = result.error;
                    document.getElementById('intel-error').style.display = 'block';
                    return;
                }

                // Display results
                document.getElementById('intel-results').style.display = 'block';

                // Extract and display BLUF
                const analysis = result.analysis?.analysis || '';
                const blufMatch = analysis.match(/## BLUF\s*([\s\S]*?)(?=##|$)/i);
                const blufText = blufMatch ? blufMatch[1].trim() : 'Analysis complete';

                // Determine risk color
                let riskColor = '#3498db';
                if (analysis.includes('CRITICAL')) riskColor = '#e94560';
                else if (analysis.includes('HIGH')) riskColor = '#e74c3c';
                else if (analysis.includes('MODERATE')) riskColor = '#f39c12';
                else if (analysis.includes('LOW')) riskColor = '#27ae60';

                document.getElementById('intel-bluf').innerHTML = `
                    <div style="font-weight:600;margin-bottom:8px;color:${riskColor}">BLUF - Bottom Line Up Front</div>
                    <div style="font-size:14px;line-height:1.6">${blufText}</div>
                `;

                // Display news results
                const newsResults = result.news_results || [];
                if (newsResults.length > 0) {
                    document.getElementById('intel-news').innerHTML = `
                        <div style="font-weight:600;margin-bottom:8px">News Coverage (${newsResults.length} articles found)</div>
                        <div style="background:#f8f9fa;padding:12px;border-radius:8px;max-height:150px;overflow-y:auto">
                            ${newsResults.slice(0, 5).map(a => `
                                <div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee">
                                    <a href="${a.url}" target="_blank" style="font-weight:500;color:#333;text-decoration:none">${a.title || 'Untitled'}</a>
                                    <div style="font-size:11px;color:#666">${a.source || ''} â¢ Query: ${a.search_query || ''}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('intel-news').innerHTML = `
                        <div style="background:#fff3cd;padding:12px;border-radius:8px;color:#856404;font-size:13px">
                            <strong>No news coverage found</strong> â This is itself intelligence. The vessel has low media visibility.
                        </div>
                    `;
                }

                // Display full analysis
                document.getElementById('intel-analysis').textContent = analysis;

            } catch (e) {
                document.getElementById('intel-loading').style.display = 'none';
                document.getElementById('intel-error').textContent = 'Analysis failed: ' + e.message;
                document.getElementById('intel-error').style.display = 'block';
            }
        }

        // Open edit vessel modal
        function openEditVesselModal(vesselId) {
            const v = vessels.find(x => x.id === vesselId);
            if (!v) return;

            document.getElementById('edit-vessel-id').value = vesselId;
            document.getElementById('edit-vessel-name').value = v.name || '';
            document.getElementById('edit-vessel-flag').value = v.flag_state || '';
            document.getElementById('edit-vessel-type').value = v.vessel_type || '';
            document.getElementById('edit-vessel-classification').value = v.classification || 'monitoring';
            document.getElementById('edit-vessel-threat').value = v.threat_level || 'unknown';
            document.getElementById('edit-vessel-notes').value = v.intel_notes || '';

            // Show existing photo or clear preview
            const preview = document.getElementById('edit-vessel-photo-preview');
            if (v.photo_url) {
                preview.innerHTML = `<img src="${v.photo_url}" style="max-width:100%;max-height:150px;border-radius:8px;border:1px solid #ddd">`;
            } else {
                preview.innerHTML = '';
            }
            // Clear file input
            document.getElementById('edit-vessel-photo').value = '';

            openModal('edit-vessel-modal');
        }

        // Save vessel edits
        async function saveVesselEdit() {
            const vesselId = document.getElementById('edit-vessel-id').value;
            const name = document.getElementById('edit-vessel-name').value.trim();

            if (!name) {
                alert('Vessel name is required');
                return;
            }

            try {
                // Update vessel info
                const result = await post(`/vessels/${vesselId}/update`, {
                    name,
                    flag_state: document.getElementById('edit-vessel-flag').value.trim() || null,
                    vessel_type: document.getElementById('edit-vessel-type').value.trim() || null,
                    classification: document.getElementById('edit-vessel-classification').value,
                    threat_level: document.getElementById('edit-vessel-threat').value,
                    intel_notes: document.getElementById('edit-vessel-notes').value.trim() || null
                });

                if (result.error) {
                    alert('Failed to update vessel: ' + result.error);
                    return;
                }

                // Upload photo if selected
                const photoInput = document.getElementById('edit-vessel-photo');
                if (photoInput.files && photoInput.files[0]) {
                    try {
                        await uploadVesselPhoto(vesselId);
                    } catch (photoErr) {
                        console.error('Photo upload failed:', photoErr);
                        alert('Vessel updated but photo upload failed.');
                    }
                }

                closeModal('edit-vessel-modal');
                await loadData();
                selectVessel(parseInt(vesselId));
                alert('Vessel updated successfully!');

            } catch (e) {
                alert('Failed to update vessel: ' + e.message);
            }
        }

        // Delete a vessel
        async function deleteVessel(vesselId) {
            const v = vessels.find(x => x.id === vesselId);
            if (!v) return;

            if (!confirm(`Delete "${v.name}"?\n\nThis will remove the vessel and all associated data (positions, events, alerts).`)) {
                return;
            }

            try {
                const result = await api(`/vessels/${vesselId}`, { method: 'DELETE' });

                if (result.error) {
                    alert('Failed to delete vessel: ' + result.error);
                    return;
                }

                closeVesselPanel();
                await loadData();
                alert('Vessel deleted successfully!');

            } catch (e) {
                alert('Failed to delete vessel: ' + e.message);
            }
        }

        // Toggle buttons
        document.getElementById('toggle-list').addEventListener('click', () => {
            document.getElementById('list-panel').classList.toggle('active');
            document.getElementById('toggle-list').classList.toggle('active');
        });

        document.getElementById('add-vessel-btn').addEventListener('click', openAddVesselModal);

        document.getElementById('toggle-shipyards').addEventListener('click', () => {
            showShipyards = !showShipyards;
            document.getElementById('toggle-shipyards').classList.toggle('active', showShipyards);
            renderShipyards();
        });

        document.getElementById('toggle-live').addEventListener('click', () => {
            showLiveVessels = !showLiveVessels;
            document.getElementById('toggle-live').classList.toggle('active', showLiveVessels);
            if (showLiveVessels) {
                document.getElementById('toggle-live').style.background = '#3498db';
                document.getElementById('toggle-live').style.color = 'white';
            } else {
                document.getElementById('toggle-live').style.background = 'white';
                document.getElementById('toggle-live').style.color = 'inherit';
            }
            renderLiveVessels();
        });

        // Escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                setMapClickMode(false);
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
            loadLiveVessels();
            document.getElementById('toggle-shipyards').classList.add('active');
            // Auto-refresh live vessels every 10 seconds
            setInterval(loadLiveVessels, 10000);
        });
    </script>
</body>
</html>
